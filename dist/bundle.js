!function(e){var n={};function t(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(o,i,function(n){return e[n]}.bind(null,i));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";t.r(n);var o=function(){var e,n;return e=["https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/drive.readonly"],(n=new gapi.auth2.SigninOptionsBuilder).setPrompt("select_account"),n.setScope(e.join(" ")),gapi.auth2.getAuthInstance().signIn(n).then(function(e){var n;return n=e.getAuthResponse(),igv.setGoogleOauthToken(n.access_token),n.access_token})},i=function(){return igv.oauth.google.access_token?Promise.resolve(igv.oauth.google.access_token):o()},r=function(e){};function a(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(){return igv.xhr.loadJson("https://s3.amazonaws.com/igv.org.restricted/bitly.json",{}).then(function(e){return e.apiKey}).catch(function(e){console.error(e)})}var l=function(){function e(n){var t=n.apiKey,o=n.hostname;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.api="https://api-ssl.bitly.com",this.apiKey=t||s,this.hostname=o||"bit.ly",this.devIP="192.168.1.11"}return function(e,n,t){n&&a(e.prototype,n),t&&a(e,t)}(e,[{key:"shortenURL",value:function(e){var n=this;return e.startsWith("http://localhost")&&(e=e.replace("localhost",this.devIP)),getApiKey().then(function(t){var o=n.api+"/v3/shorten?access_token="+t+"&longUrl="+encodeURIComponent(e);return igv.xhr.loadJson(o,{})}).then(function(e){return e.data.url})}},{key:"expandURL",value:function(e){var n=this;return this.getApiKey.call(this).then(function(t){var o=n.api+"/v3/expand?access_token="+t+"&shortUrl="+encodeURIComponent(e);return igv.xhr.loadJson(o,{})}).then(function(e){var n=e.data.expand[0].long_url;return n=n.replace("{","%7B").replace("}","%7D")})}},{key:"getApiKey",value:function(){var e;if("string"==typeof this.apiKey)return Promise.resolve(this.apiKey);if("function"==typeof this.apiKey){if("function"==typeof(e=this.apiKey()).then){var n=this;return e.then(function(e){return n.apiKey=e,e})}return this.apiKey=e,Promise.resolve(e)}throw new Error("Unknown apiKey type: "+this.apiKey)}}]),e}();function c(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(){return igv.xhr.loadJson("https://s3.amazonaws.com/igv.org.restricted/google.json",{}).then(function(e){return e.apiKey}).catch(function(e){console.error(e)})}var d=function(){function e(n){var t=n.apiKey,o=n.hostname;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.api="https://www.googleapis.com/urlshortener/v1/url",this.apiKey=t||u,this.hostname=o||"goo.gl"}return function(e,n,t){n&&c(e.prototype,n),t&&c(e,t)}(e,[{key:"shortenURL",value:function(e){var n=this;return this.getApiKey().then(function(t){var o=n.api+"?key="+t;return igv.xhr.loadJson(o,{sendData:JSON.stringify({longUrl:e}),contentType:"application/json"})}).then(function(e){return e.id})}},{key:"expandURL",value:function(e){var n=this;return this.getApiKey().then(function(t){var o;return e.includes("goo.gl")?(o=n.api+"?shortUrl="+e+"&key="+t,igv.xhr.loadJson(o,{contentType:"application/json"}).then(function(e){return e.longUrl})):Promise.resolve(e)})}},{key:"getApiKey",value:function(){var e;if("string"==typeof this.apiKey)return Promise.resolve(this.apiKey);if("function"==typeof this.apiKey){if("function"==typeof(e=this.apiKey()).then){var n=this;return e.then(function(e){return n.apiKey=e,e})}return this.apiKey=e,Promise.resolve(e)}throw new Error("Unknown apiKey type: "+this.apiKey)}}]),e}();function f(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var p=function(e){var n,t,o,i,r;if(n=v(e),!1!==g(n)){var a,s;if(t=e.split(".").pop(),(i={})[r=e+"."+(o=w(t)).index]={},i[r].data=e,i[r].isOptional=o.isOptional,"bam"===n)(s=e.split(".")).pop(),i[a=s.join(".")+"."+o.index]={},i[a].data=e,i[a].isOptional=o.isOptional;return i}},g=function(e){var n;return n=new Set(["fa","fasta"]),new Set(f(igv.knownFileExtensions).concat(f(n))).has(e)},h=function(e){return e.google_url?e.name:igv.getFilename(e)},v=function(e){return igv.getExtension({url:e.google_url?e.name:e})},m=function(e){return!0==e instanceof Object&&!1==e instanceof File},b=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;n.find(".modal-header button:nth-child(1)").on("click",function(){e.dismiss(),n.modal("hide")}),n.find(".modal-footer button:nth-child(1)").on("click",function(){e.dismiss(),n.modal("hide")}),n.find(".modal-footer button:nth-child(2)").on("click",function(){t?t(e.fileLoadManager):e.fileLoadManager.okHandler(),e.dismiss(),n.modal("hide")})},y=function(e){igv.browser.loadGenome(e).then(function(e){W.updateGeneralizedAnnotations(e.id)}).catch(function(e){igv.browser.presentAlert(e)})},w=function(e){var n;return(n={fa:{index:"fai",isOptional:!0},fasta:{index:"fai",isOptional:!0},bam:{index:"bai",isOptional:!1},gz:{index:"tbi",isOptional:!0}})[e]?n[e]:{index:"idx",isOptional:!0}};function k(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function x(e){return igv.isFilePath(e)?e.name:e}var T=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.dictionary={},this.keyToIndexExtension={bam:{extension:"bai",optional:!1},any:{extension:"idx",optional:!0},gz:{extension:"tbi",optional:!0}},this.indexExtensionToKey={bai:"bam",idx:"any",tbi:"gz"}}return function(e,n,t){n&&k(e.prototype,n),t&&k(e,t)}(e,[{key:"okHandler",value:function(){var e;(e=this.trackLoadConfiguration())&&function(e){var n;return void 0===e.name&&igv.isString(e.url)&&e.url.includes("drive.google.com")?(n=function(e){var n,t,o,i,r,a,s;if(a={},n=e.indexOf("?"),t=e.lastIndexOf("#"),n>=0)for(t<0&&(t=e.length),o=n+1;o<t;)(i=e.indexOf("&",o))<0&&(i=t),r=e.substring(o,i),2===(s=r.split("=",2)).length&&(a[s[0]]=s[1]),o=i+1;return a}(e.url),n.id,igv.Google.getDriveFileInfo(e.url).then(function(e){return e.originalFilename||e.name})):void 0===e.name?Promise.resolve(function(e){var n,t;return igv.isFilePath(e)?e.name:(t=e.split("?").shift(),(n=e.lastIndexOf("/"))>0?t.substring(n+1):t)}(e.url)):Promise.resolve(e.name)}(e).then(function(n){e.filename=e.name=n,igv.browser.loadTrackList([e])}).catch(function(n){console.error(n),igv.browser.loadTrackList([e])})}},{key:"inputHandler",value:function(e,n){this.ingestPath(e,n)}},{key:"didDragDrop",value:function(e){var n;return(n=e.files)&&n.length>0}},{key:"dragDropHandler",value:function(e,n){var t,o;t=e.getData("text/uri-list"),(o=e.files)&&o.length>0?this.ingestPath(o[0],n):t&&""!==t&&this.ingestPath(t,n)}},{key:"indexName",value:function(){return x(this.dictionary.index)}},{key:"dataName",value:function(){return x(this.dictionary.data)}},{key:"reset",value:function(){this.dictionary={}}},{key:"trackLoadConfiguration",value:function(){var e,n,t,o,i;return void 0===this.dictionary.data?void this.fileLoadWidget.presentErrorMessage("Error: No data file"):!0===m(this.dictionary.data)?this.dictionary.data:this.dictionary.index&&!1===this.isAnIndexFile(this.dictionary.index)?void this.fileLoadWidget.presentErrorMessage("Error: index file is not valid."):(o=this.isIndexable(this.dictionary.data),e=igv.getExtension({url:this.dictionary.data}),n=this.keyToIndexExtension[e]?e:"any",i=this.keyToIndexExtension[n],!0===o&&!1===i.optional?void 0===this.dictionary.index?void this.fileLoadWidget.presentErrorMessage("Error: index file must be provided."):{url:this.dictionary.data,indexURL:this.dictionary.index}:(t={url:this.dictionary.data,indexURL:this.dictionary.index||void 0},void 0===this.dictionary.index&&(t.indexed=!1),t))}},{key:"ingestPath",value:function(e,n){var t=this;"json"===igv.getExtension({url:e})||this.googlePickerFilename&&"json"===igv.getExtension({url:this.googlePickerFilename})?igv.xhr.loadJson(e).then(function(e){t.dictionary[!0===n?"index":"data"]=e}).catch(function(e){t.fileLoadWidget.presentErrorMessage("Error: Invalid JSON.")}):this.dictionary[!0===n?"index":"data"]=e}},{key:"isAnIndexFile",value:function(e){var n;return n=igv.getExtension({url:e}),this.indexExtensionToKey.hasOwnProperty(n)}},{key:"isIndexable",value:function(e){var n;return!0!==this.isAnIndexFile(e)&&("wig"!==(n=igv.getExtension({url:e}))&&"seg"!==n)}}]),e}();function C(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var E=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var o,i=this;this.config=n,this.config.dataTitle=n.dataTitle||"Data",this.config.indexTitle=n.indexTitle||"Index",this.$parent=n.$widgetParent,this.fileLoadManager=t,this.fileLoadManager.fileLoadWidget=this,this.$container=$("<div>",{class:"igv-file-load-widget-container"}),this.$parent.append(this.$container),o="localFile"===n.mode?{doURL:!1,dataTitle:n.dataTitle+" file",indexTitle:n.indexTitle+" file"}:{doURL:!0,dataTitle:n.dataTitle+" URL",indexTitle:n.indexTitle+" URL"},this.createInputContainer(this.$container,o),this.$error_message=$("<div>",{class:"igv-flw-error-message-container"}),this.$container.append(this.$error_message),this.$error_message.append($("<div>",{class:"igv-flw-error-message"})),igv.attachDialogCloseHandlerWithParent(this.$error_message,function(){i.dismissErrorMessage()}),this.dismissErrorMessage()}return function(e,n,t){n&&C(e.prototype,n),t&&C(e,t)}(e,[{key:"presentErrorMessage",value:function(e){this.$error_message.find(".igv-flw-error-message").text(e),this.$error_message.show()}},{key:"dismissErrorMessage",value:function(){this.$error_message.hide(),this.$error_message.find(".igv-flw-error-message").text("")}},{key:"present",value:function(){this.$container.show()}},{key:"dismiss",value:function(){this.dismissErrorMessage(),this.$container.find("input").val(void 0),this.$container.find(".igv-flw-local-file-name-container").hide(),this.fileLoadManager.reset()}},{key:"customizeLayout",value:function(e){e(this.$container)}},{key:"createInputContainer",value:function(e,n){var t,o,i,r;t=$("<div>",{class:"igv-flw-input-container"}),e.append(t),o=$("<div>",{class:"igv-flw-input-row"}),t.append(o),r=$("<div>",{class:"igv-flw-input-label"}),o.append(r),r.text(n.dataTitle),!0===n.doURL?this.createURLContainer(o,"igv-flw-data-url",!1):this.createLocalFileContainer(o,"igv-flw-local-data-file",!1),i=$("<div>",{class:"igv-flw-input-row"}),t.append(i),r=$("<div>",{class:"igv-flw-input-label"}),i.append(r),r.text(n.indexTitle),!0===n.doURL?this.createURLContainer(i,"igv-flw-index-url",!0):this.createLocalFileContainer(i,"igv-flw-local-index-file",!0)}},{key:"createURLContainer",value:function(e,n,t){var o,i=this;o=$("<input>",{type:"text",placeholder:!0===t?"Enter index URL":"Enter data URL"}),e.append(o),o.on("focus",function(){i.dismissErrorMessage()}),o.on("change",function(e){i.dismissErrorMessage(),i.fileLoadManager.inputHandler($(this).val(),t)}),e.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation(),i.dismissErrorMessage()}).on("dragover dragenter",function(e){$(this).addClass("igv-flw-input-row-hover-state")}).on("dragleave dragend drop",function(e){$(this).removeClass("igv-flw-input-row-hover-state")}).on("drop",function(e){!1===i.fileLoadManager.didDragDrop(e.originalEvent.dataTransfer)&&(i.fileLoadManager.dragDropHandler(e.originalEvent.dataTransfer,t),o.val(t?i.fileLoadManager.indexName():i.fileLoadManager.dataName()))})}},{key:"createLocalFileContainer",value:function(e,n,t){var o,i,r,a,s,l=this;o=$("<div>",{class:"igv-flw-file-chooser-container"}),e.append(o),s=n+igv.guid(),i=$("<label>",{for:s}),o.append(i),i.text("Choose file"),r=$("<input>",{class:"igv-flw-file-chooser-input",id:s,name:s,type:"file"}),o.append(r),o.hover(function(){i.removeClass("igv-flw-label-color"),i.addClass("igv-flw-label-color-hover")},function(){i.removeClass("igv-flw-label-color-hover"),i.addClass("igv-flw-label-color")}),a=$("<div>",{class:"igv-flw-local-file-name-container"}),e.append(a),a.hide(),r.on("change",function(e){l.dismissErrorMessage(),l.fileLoadManager.inputHandler(e.target.files[0],t),a.text(e.target.files[0].name),a.attr("title",e.target.files[0].name),a.show()}),e.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation(),l.dismissErrorMessage()}).on("dragover dragenter",function(e){$(this).addClass("igv-flw-input-row-hover-state")}).on("dragleave dragend drop",function(e){$(this).removeClass("igv-flw-input-row-hover-state")}).on("drop",function(e){var n;!0===l.fileLoadManager.didDragDrop(e.originalEvent.dataTransfer)&&(l.fileLoadManager.dragDropHandler(e.originalEvent.dataTransfer,t),n=t?l.fileLoadManager.indexName():l.fileLoadManager.dataName(),a.text(n),a.attr("title",n),a.show())})}}]),e}();function L(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var _=function(){function e(n,t){var o=t.$urlModal,i=t.genomes;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var r,a,s=this;this.genomes=i,r={dataTitle:"Genome",$widgetParent:o.find(".modal-body"),mode:"url"},this.urlWidget=new E(r,new T),a=function(e){!function(e,n){(function(e){var n=!0;void 0===e.dictionary?n=!1:void 0===e.dictionary.data?n=!1:void 0===e.dictionary.data&&void 0===e.dictionary.index&&(n=!1);return n})(n)&&e.genomeConfiguration(n).then(function(e){var n;n=Object.values(e).pop(),y(n)})}(s,e)},b(this.urlWidget,o,a)}return function(e,n,t){n&&L(e.prototype,n),t&&L(e,t)}(e,[{key:"getAppLaunchGenomes",value:function(){var e;return this.genomes?Array.isArray(this.genomes)?Promise.resolve(n(this.genomes)):(e=this.genomes,igv.xhr.loadJson(e,{}).then(function(e){return n(e)})):Promise.resolve(void 0);function n(e){var n;return n={},!0===Array.isArray(e)?e.forEach(function(e){n[e.id]=e}):n[e.id]=e,n}}},{key:"genomeConfiguration",value:function(e){var n;return!0===m(e.dictionary.data)?((n={}).noname=e.dictionary.data,Promise.resolve(n)):((n={}).noname={fastaURL:e.dictionary.data,indexURL:e.dictionary.index},Promise.resolve(n))}}]),e}();function O(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function A(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function P(e){return e?e[0]?e[0].path:e[1]?e[1].path:void 0:void 0}function S(e,n){var t,o,i;n&&n[e]?(o=n[e][0],1===n[e].length?t=void 0===o:(i=n[e][1],t=!o&&!i)):t=!1;return t}var R=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.browser=n,this.fileLoadHander=t.fileLoadHandler,this.configurationHandler=t.configurationHandler,this.$modal=t.$modal,this.$modal.find(".modal-title").text(t.modalTitle),this.$modal_body=this.$modal.find(".modal-body"),this.createLocalInput(t.$localFileInput),this.createDropboxButton(t.$dropboxButton),t.$googleDriveButton&&this.createGoogleDriveButton(t.$googleDriveButton)}return function(e,n,t){n&&A(e.prototype,n),t&&A(e,t)}(e,[{key:"ingestPaths",value:function(e){var n,t,o,i,r,a,s,l=this;for(var c in this.$modal_body.empty(),a=e.filter(function(e){return"json"===v(e)}).map(function(e){var n;return n=e.google_url||e,{name:h(e),promise:igv.xhr.loadJson(n)}}),n=e.filter(function(e){return g(v(e))}).reduce(function(e,n){return e[h(n)]=n.google_url||n,e},{}),t=e.filter(function(e){return function(e){return new Set(["fai","bai","tbi","idx"]).has(v(e))}(v(e))}).reduce(function(e,n){return e[h(n)]=n.google_url||n,e},{}),o=function(e,n){var t;return t=Object.keys(e).map(function(e){var t;for(var o in t=p(e))t.hasOwnProperty(o)&&(t[o].missing=void 0===n[o]);return t}).filter(function(e){var n;return 1!==Object.keys(e).length||(!0!==(n=e[Object.keys(e)[0]]).missing||!0!==n.isOptional)&&(!1===n.missing&&!1===n.isOptional||(!0===n.missing&&n.isOptional,!0))}),t.reduce(function(e,t){for(var o in t)if(t.hasOwnProperty(o)){var i;void 0===e[(i=t[o]).data]&&(e[i.data]=[]),e[i.data].push(!1===i.missing?{name:o,path:n[o]}:void 0)}return e},{})}(n,t),i=new Set,o)o.hasOwnProperty(c)&&o[c].forEach(function(e){e&&i.add(e.name)});r=Object.keys(t).reduce(function(e,n){return!1===i.has(n)&&e.push(n),e},[]),s=Object.keys(n).reduce(function(e,t){return!1===S(t,o)&&e.push(l.configurationHandler(t,n[t],o)),e},[]),a.length>0?this.jsonRetrievalSerial(a,s,n,o,r):(s.length>0&&this.fileLoadHander(s),this.renderTrackFileSelection(n,o,r,new Set))}},{key:"createLocalInput",value:function(n){var t=this;n.on("change",function(){var n;!0===e.isValidLocalFileInput($(this))&&(n=$(this).get(0),t.ingestPaths(Array.from(n.files)))})}},{key:"createDropboxButton",value:function(e){var n=this;e.on("click",function(){var e;e={success:function(e){return n.ingestPaths(e.map(function(e){return e.link}))},cancel:function(){},linkType:"preview",multiselect:!0,folderselect:!1},Dropbox.choose(e)})}},{key:"createGoogleDriveButton",value:function(e){var n,t=this;e.on("click",function(){!function(e){i().then(function(e){return r(!0),Promise.resolve(e)}).then(function(n){var t,o;(t=new google.picker.DocsView(google.picker.ViewId.DOCS)).setIncludeFolders(!0),(o=new google.picker.DocsView(google.picker.ViewId.DOCS)).setEnableTeamDrives(!0),o.setIncludeFolders(!0),n?(new google.picker.PickerBuilder).setOAuthToken(igv.oauth.google.access_token).addView(t).addView(o).enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setCallback(function(n){n[google.picker.Response.ACTION]===google.picker.Action.PICKED&&e(n[google.picker.Response.DOCUMENTS])}).build().setVisible(!0):igv.browser.presentAlert("Sign into Google before using picker")}).catch(function(e){console.log(e)})}(function(e){n=e.map(function(e){return{name:e.name,google_url:e.url}}),t.ingestPaths(n)})})}},{key:"jsonRetrievalParallel",value:function(e,n,t,o,i){var r=this;Promise.all(e.map(function(e){return e.promise})).then(function(e){var a;e&&e.length>0?(a=e.reduce(function(e,n){return!0===Array.isArray(n)?n.forEach(function(n){e.push(n)}):e.push(n),e},[]),n.push.apply(n,a),r.fileLoadHander(n),r.renderTrackFileSelection(t,o,i,new Set)):r.renderTrackFileSelection(t,o,i,new Set)}).catch(function(e){console.log(e),r.renderTrackFileSelection(t,o,i,new Set)})}},{key:"jsonRetrievalSerial",value:function(e,n,t,o,i){var r,a,s,l=this;r=new Set(e.map(function(e){return e.name})),a=new Set,s=[],e.reduce(function(e,n){return e.then(function(e){return n.promise.then(function(t){return a.add(n.name),console.log("parsed json file: "+n.name),s=O(e).concat([t])})})},Promise.resolve([])).then(function(e){l.jsonConfigurator(t,o,i,s,n,r,a)}).catch(function(e){l.jsonConfigurator(t,o,i,s,n,r,a)})}},{key:"renderTrackFileSelection",value:function(e,n,t,o){var i,r;(i=Object.keys(e).reduce(function(e,t){return!0===S(t,n)&&e.push("<div><span>&nbsp;&nbsp;&nbsp;&nbsp;"+t+"</span>&nbsp;&nbsp;&nbsp;ERROR: index file must also be selected</div>"),e},[]),t.forEach(function(e){i.push("<div><span>&nbsp;&nbsp;&nbsp;&nbsp;"+e+"</span>&nbsp;&nbsp;&nbsp;ERROR: data file must also be selected</div>")}),o.forEach(function(e){i.push("<div><span>&nbsp;&nbsp;&nbsp;&nbsp;"+e+"</span>&nbsp;&nbsp;&nbsp;ERROR: problems parsing JSON</div>")}),i.length>0)&&(r="<div> The following files were not loaded ...</div>",i.unshift(r),this.$modal_body.append(i.join("")),this.$modal.modal("show"))}},{key:"jsonConfigurator",value:function(e,n,t,o,i,r,a){var s,l;o.length>0?(l=o.reduce(function(e,n){return!0===Array.isArray(n)?n.forEach(function(n){e.push(n)}):e.push(n),e},[]),i.push.apply(i,l),this.fileLoadHander(i),s=O(r).filter(function(e){return!a.has(e)}),this.renderTrackFileSelection(e,n,t,s)):(i.length>0&&this.fileLoadHander(i),s=O(r).filter(function(e){return!a.has(e)}),this.renderTrackFileSelection(e,n,t,s))}}],[{key:"isValidLocalFileInput",value:function(e){return e.get(0).files&&e.get(0).files.length>0}},{key:"trackConfigurator",value:function(e,n,t){var o;return o={name:e,filename:e,format:igv.inferFileFormat(e),url:n,indexURL:P(t[e])},igv.inferTrackTypes(o),o}},{key:"genomeConfigurator",value:function(e,n,t){return{fastaURL:n,indexURL:P(t[e])}}}]),e}();function M(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function D(e){var n=e["Cell Type"]||"";e.Target&&(n+=" "+e.Target),"chip-seq"!==e["Assay Type"].toLowerCase()&&(n+=" "+e["Assay Type"]),e["Bio Rep"]&&(n+=" "+e["Bio Rep"]),e["Tech Rep"]&&(n+=(e["Bio Rep"]?":":" 0:")+e["Tech Rep"]),n+=" "+e["Output Type"],n+=" "+e.Experiment,e.Name=n}function j(e,n){var t,o,i,r,a,s;return t=e["Assay Type"],o=n["Assay Type"],i=e["Cell Type"],r=n["Cell Type"],a=e.Target,s=n.Target,t===o?i===r?a===s?0:a<s?-1:1:i<r?-1:1:t<o?-1:1}var I=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.columnFormat=n}return function(e,n,t){n&&M(e.prototype,n),t&&M(e,t)}(e,[{key:"retrieveData",value:function(e,n){var t="https://s3.amazonaws.com/igv.org.app/encode/"+e+".txt.gz";return igv.xhr.loadString(t,{}).then(function(e){return function(e,n){if(!e)return null;var t,o,i=[];(t=igv.getDataWrapper(e)).nextLine();for(;o=t.nextLine();){var r=o.split("\t"),a={Assembly:r[1],ExperimentID:r[0],Experiment:r[0].substr(13).replace("/",""),"Cell Type":r[2],"Assay Type":r[3],Target:r[4],Format:r[8],"Output Type":r[7],Lab:r[9],url:"https://www.encodeproject.org"+r[10],"Bio Rep":r[5],"Tech Rep":r[6]};D(a),(void 0===n||n(a))&&i.push(a)}return i}(e,n)}).then(function(e){return e.sort(j),Promise.resolve(e)})}},{key:"tableData",value:function(e){var n=this;return e.map(function(e){return n.columnFormat.map(function(e){return Object.keys(e)[0]}).map(function(n){return e[n]})})}},{key:"tableColumns",value:function(){return this.columnFormat.map(function(e){var n;return{title:n=Object.keys(e)[0],width:e[n]}})}},{key:"dataAtRowIndex",value:function(e,n){var t,o=e[n],i=function(e){var n=e.Format,t=e["Output Type"],o=e["Assay Type"];return"bedpe"===n&&t&&t.includes("domain")?"bedpe-domain":"tsv"===n&&t.includes("interaction")&&"hic"===o.toLowerCase()?"bedpe-loop":n}(o);return"bedpe-domain"===i?t="annotation":"bedpe-loop"===i&&(t="interaction"),{url:o.url,color:function(e){var n,t;n={DEFAULT:"rgb(3, 116, 178)",H3K27AC:"rgb(200, 0, 0)",H3K27ME3:"rgb(130, 0, 4)",H3K36ME3:"rgb(0, 0, 150)",H3K4ME1:"rgb(0, 150, 0)",H3K4ME2:"rgb(0, 150, 0)",H3K4ME3:"rgb(0, 150, 0)",H3K9AC:"rgb(100, 0, 0)",H3K9ME1:"rgb(100, 0, 0)"},t=void 0===e||""===e||"-"===e?"DEFAULT":e.toUpperCase();return n[t]}(o.Target),name:o.Name,format:i,type:t}}}]),e}();function F(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var U=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.config=n,this.datasource=n.datasource,this.browserHandler=n.browserHandler,function(e){[e.$modal,e.$modalTopCloseButton,e.$modalBottomCloseButton,e.$modalGoButton].forEach(function(e){e.unbind()}),e.$modalBody.empty()}(n),this.$table=$('<table cellpadding="0" cellspacing="0" border="0" class="display"></table>'),n.$modalBody.append(this.$table),this.$modal=n.$modal,this.doBuildTable=!0,this.$spinner=$("<div>"),this.$table.append(this.$spinner),this.$faSpinner=igv.createIcon("spinner"),this.$spinner.append(this.$faSpinner)}return function(e,n,t){n&&F(e.prototype,n),t&&F(e,t)}(e,[{key:"startSpinner",value:function(){this.$faSpinner.addClass("fa5-spin"),this.$spinner.show()}},{key:"stopSpinner",value:function(){this.$spinner.hide(),this.$faSpinner.addClass("fa5-spin")}},{key:"didFailToRetrieveData",value:function(){this.stopSpinner(),this.buildTable(!1)}},{key:"promisifiedLoadData",value:function(n){var t,o=this;return(t=e.getAssembly(n))?this.datasource.retrieveData(t,function(e){return"bigbed"!==e.Format.toLowerCase()}).catch(function(e){o.didFailToRetrieveData()}):Promise.resolve(void 0)}},{key:"buildTableWithData",value:function(e){this.datasource.data=e,this.startSpinner(),this.buildTable(!0)}},{key:"buildTable",value:function(e){var n=this;!0===e&&(this.config.$modal.on("shown.bs.modal",function(e){!0===n.doBuildTable&&(n.tableWithDataAndColumns(n.datasource.tableData(n.datasource.data),n.datasource.tableColumns()),n.stopSpinner(),n.doBuildTable=!1)}),this.config.$modalGoButton.on("click",function(){var e;(e=function(e){var n,t,o=this;t=[],e.length>0&&(e.removeClass("selected"),n=o.$table.DataTable(),e.each(function(){t.push(o.datasource.dataAtRowIndex(o.datasource.data,n.row(this).index()))}));return t.length>0?t:void 0}.call(n,n.$dataTables.$("tr.selected")))&&n.browserHandler(e)})),this.config.$modalTopCloseButton.on("click",function(){$("tr.selected").removeClass("selected")}),this.config.$modalBottomCloseButton.on("click",function(){$("tr.selected").removeClass("selected")})}},{key:"tableWithDataAndColumns",value:function(e,n){var t;t={data:e,columns:n,autoWidth:!0,paging:!0,lengthMenu:[100,250,500,750,1e3],pageLength:1e3,scrollX:!0,scrollY:"400px",scroller:!0,scrollCollapse:!0},console.log("ModalTable.tableWithDataAndColumns "+e.length+" rows ..."),this.$dataTables=this.$table.dataTable(t),console.log("... tableWithDataAndColumns done"),this.$table.find("tbody").on("click","tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):$(this).addClass("selected")})}}],[{key:"getAssembly",value:function(e){return{dm3:"dm3",mm10:"mm10",hg19:"hg19",hg38:"GRCh38"}[e]}}]),e}();function K(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var B={hg19:"gtex_v7"};var H=function(){function e(n,t){var o,i=t.$urlModal,r=t.$encodeModal,a=t.$dropdownMenu,s=t.$genericTrackSelectModal;!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.browser=n,this.$modal=s,this.$dropdownMenu=a,this.$encodeModal=r,o={$widgetParent:i.find(".modal-body"),mode:"url"},this.urlWidget=new E(o,new T),b(this.urlWidget,i),this.updateGeneralizedAnnotations(n.genome.id)}return function(e,n,t){n&&K(e.prototype,n),t&&K(e,t)}(e,[{key:"createEncodeTable",value:function(e){var n,t,o=this;return this.encodeTable=void 0,n=new I([{"Cell Type":"10%"},{Target:"10%"},{"Assay Type":"10%"},{"Output Type":"20%"},{"Bio Rep":"5%"},{"Tech Rep":"5%"},{Format:"5%"},{Experiment:"10%"},{Lab:"20%"}]),t={$modal:this.$encodeModal,$modalBody:this.$encodeModal.find(".modal-body"),$modalTopCloseButton:this.$encodeModal.find(".modal-header button:nth-child(1)"),$modalBottomCloseButton:this.$encodeModal.find(".modal-footer button:nth-child(1)"),$modalGoButton:this.$encodeModal.find(".modal-footer button:nth-child(2)"),datasource:n,browserHandler:function(e){o.browser.loadTrackList(e)}},this.encodeTable=new U(t),this.encodeTable.promisifiedLoadData(e)}},{key:"updateGeneralizedAnnotations",value:function(e){var n,t,o,i=this;o=i.$dropdownMenu.find("#igv-app-annotations-section"),i.$dropdownMenu.find("[id^=genome_specific_]").remove(),t=(n="resources/tracks")+"/"+e+"_tracks.txt",igv.xhr.loadString(t).then(function(t){var r,a,s,l,c;r=t.split("\n").filter(function(e){return!(""===e)}),c=r.map(function(e){return e.split(".").shift()}),a=r.map(function(e,t){return{name:c[t],promise:igv.xhr.loadJson(n+"/"+e)}}).reverse(),U.getAssembly(e)&&(s={name:"ENCODE",promise:i.createEncodeTable(e)},a.unshift(s)),B[e]&&(l={name:"GTEx",promise:igv.GtexUtils.getTissueInfo(B[e])},a.unshift(l)),Promise.all(a.map(function(e){return e.promise})).then(function(e){var n,t;n=e.map(function(e){var n;return e.tissueSummary?(n=e,Object.defineProperty(n,"tracks",Object.getOwnPropertyDescriptor(n,"tissueSummary")),delete n.tissueSummary,n.label="GTEx"):n=Array.isArray(e)?{label:"ENCODE",data:e}:e,n}),t=a.map(function(e){return e.name}),n.forEach(function(e,n){var r,a,s;r=$("<button>",{class:"dropdown-item",type:"button"}),s=e.label+" ...",r.text(s),a="genome_specific_"+e.label.toLowerCase().split(" ").join("_"),r.attr("id",a),r.insertAfter(o),r.on("click",function(){var o;o=e.description||e.label,i.$modal.find("#igv-app-generic-track-select-modal-label").html(o),"ENCODE"===e.label?(i.encodeTable.buildTableWithData(e.data),i.encodeTable.$modal.modal("show")):(!function(e,n,t){var o,i;e.find("select").remove(),o=$("<select>",{class:"form-control"}),e.find(".form-group").append(o),i=$("<option>",{text:"Choose one of the following..."}),o.append(i),i.attr("selected","selected"),i.val(void 0),n.reduce(function(e,n){var r;return r="GTEx"===t?igv.GtexUtils.trackConfiguration(n):n,i=$("<option>",{value:r.name,text:r.name}),o.append(i),i.data("track",r),e.append(i),e},o),o.on("change",function(n){var t,o;t=$(this).find("option:selected"),""===t.val()||(o=t.data("track"),t.removeAttr("selected"),igv.browser.loadTrack(o)),e.modal("hide")})}(i.$modal,e.tracks,t[n]),i.$modal.modal("show"))})})})}).catch(function(e){console.log("ERROR "+e.message)})}}]),e}();var G=function e(n,t,o){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),o.$modal.on("show.bs.modal",function(e){var t,i;(i=(t=window.location.href.slice()).indexOf("?"))>0&&(t=t.substring(0,i));var r=igv.browser.compressedSession(),a=function(e,n,t){var o=(n||function(){var e,n;return e=window.location.href.slice(),(n=e.indexOf("?"))>0&&(e=e.substring(0,n)),n=e.lastIndexOf("/"),e.substring(0,n)+"/embed.html"}())+"?sessionURL=blob:"+t,i=e.height()+50;return'<iframe src="'+o+'" style="width:100%; height:'+i+'px"  allowfullscreen></iframe>'}(n,o.embedTarget,r);o.$embed_container.find("textarea").val(a),o.$embed_container.find("textarea").get(0).select(),app.shortSessionURL(t,r).then(function(e){var n;return o.$share_input.val(e),o.$share_input.get(0).select(),o.$email_button.attr("href","mailto:?body="+e),o.$qrcode_image.empty(),n={width:128,height:128,correctLevel:QRCode.CorrectLevel.H},new QRCode(o.$qrcode_image.get(0),n).makeCode(e),o.$tweet_button_container?(o.$tweet_button_container.empty(),n={text:""},window.twttr.widgets.createShareButton(e,o.$tweet_button_container.get(0),n)):Promise.resolve(void 0)})}),o.$modal.on("hidden.bs.modal",function(e){o.$embed_container.hide(),o.$qrcode_image.hide()}),o.$copy_link_button.on("click",function(e){o.$share_input.get(0).select(),document.execCommand("copy")?o.$modal.modal("hide"):console.log("fail!")}),o.$embed_container.find("button").on("click",function(e){o.$embed_container.find("textarea").get(0).select(),document.execCommand("copy")?o.$modal.modal("hide"):console.log("fail!")}),o.$embed_button.on("click",function(e){o.$qrcode_image.hide(),o.$embed_container.toggle()}),o.$qrcode_button.on("click",function(e){o.$embed_container.hide(),o.$qrcode_image.toggle()})};var W,N=function(e,n){if(n.googleConfig){var t={callback:function(){(function(e){var n;return n={clientId:e,scope:["https://www.googleapis.com/auth/cloud-platform","https://www.googleapis.com/auth/genomics","https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/drive.readonly"].join(" ")},gapi.client.init(n)})(n.googleConfig.clientId).then(function(){return n.googleConfig.apiKey&&(n.igvConfig.apiKey=n.googleConfig.apiKey),igv.createBrowser(e.get(0),n.igvConfig)}).then(function(t){!function(){var e;gapi.auth2.getAuthInstance().isSignedIn.listen(r),e={callback:function(){console.log("Google Picker library loaded successfully")},onerror:function(){console.log("Error loading Google Picker library"),alert("Error loading Google Picker library")}},gapi.load("picker",e)}(),q(t,e,n)})},onerror:function(){console.log("gapi.client:auth2 - failed to load!")}};gapi.load("client:auth2",t)}else igv.createBrowser(e.get(0),n.igvConfig).then(function(t){q(t,e,n)})},q=function(e,n,t){var o,i,r,a,s,c,u,f;z($(".igv-app-footer").find("a img")),J($("#igv-app-bookmark-button")),o=$("#igv-app-multiple-file-load-modal"),u=$("#igv-app-dropdown-google-drive-track-file-button"),void 0===t.googleConfig&&u.parent().hide(),i={$modal:o,modalTitle:"Track File Error",$localFileInput:$("#igv-app-dropdown-local-track-file-input"),$dropboxButton:$("#igv-app-dropdown-dropbox-track-file-button"),$googleDriveButton:t.googleConfig?u:void 0,configurationHandler:R.trackConfigurator,fileLoadHandler:function(n){e.loadTrackList(n)}},new R(e,i),f=$("#igv-app-dropdown-google-drive-genome-file-button"),void 0===t.googleConfig&&f.parent().hide(),r={$modal:o,modalTitle:"Genome File Error",$localFileInput:$("#igv-app-dropdown-local-genome-file-input"),$dropboxButton:$("#igv-app-dropdown-dropbox-genome-file-button"),$googleDriveButton:t.googleConfig?f:void 0,configurationHandler:R.genomeConfigurator,fileLoadHandler:function(e){var n;n=e[0],y(n)}},new R(e,r),s={$urlModal:$("#igv-app-genome-from-url-modal"),genomes:t.genomes},new _(e,s).getAppLaunchGenomes().then(function(n){n&&function(e){var n,t,o=e.browser,i=e.genomeDictionary,r=e.$dropdown_menu;for(var a in(n=r.find("#igv-app-genome-dropdown-divider")).prevAll().remove(),i)i.hasOwnProperty(a)&&((t=s(a)).insertBefore(n),t.on("click",function(){var e;(e=$(this).text())!==o.genome.id&&y(i[e])}));function s(e){var n;return(n=$("<button>",{class:"dropdown-item",type:"button"})).text(e),n}}({browser:e,genomeDictionary:n,$dropdown_menu:$("#igv-app-genome-dropdown-menu")})}),a={$urlModal:$("#igv-app-track-from-url-modal"),$encodeModal:$("#igv-app-encode-modal"),$dropdownMenu:$("#igv-app-track-dropdown-menu"),$genericTrackSelectModal:$("#igv-app-generic-track-select-modal")},W=new H(e,a);var p=$("#igv-app-tweet-button-container");t.urlShortener?function(e){"function"==typeof e?{shortenURL:e}:e.provider?"google"===e.provider?new d(e):"bitly"===e.provider?new l(e):igv.browser.presentAlert("Unknown url shortener provider: "+e.provider):igv.browser.presentAlert("URL shortener object must either be an object specifying a now provider or a function")}(t.urlShortener):p.hide(),c={$modal:$("#igv-app-share-modal"),$share_input:$("#igv-app-share-input"),$copy_link_button:$("#igv-app-copy-link-button"),$tweet_button_container:t.urlShortenerConfig?p:void 0,$email_button:$("#igv-app-email-button"),$embed_button:$("#igv-app-embed-button"),$qrcode_button:$("#igv-app-qrcode-button"),$embed_container:$("#igv-app-embed-container"),$qrcode_image:$("#igv-app-qrcode-image")},new G(n,e,c)},z=function(e){e.hover(function(){$(void 0).attr("src",$(void 0).attr("src").replace(/\.png/,"-hover.png"))},function(){$(void 0).attr("src",$(void 0).attr("src").replace(/-hover\.png/,".png"))})},J=function(e){e.on("click",function(e){var n;window.history.pushState({},"IGV",function(){var e,n;return((n=(e=window.location.href.slice()).indexOf("?"))>0?e.substring(0,n):e)+"?sessionURL=blob:"+igv.browser.compressedSession()}()),n=/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl",alert("A bookmark URL has been created. Press "+n+"+D to save.")})};$(document).ready(function(){N($("#igv-app-container"),{genomes:"https://s3.amazonaws.com/igv.org.genomes/genomes.json",igvConfig:{queryParametersSupported:!0,showChromosomeWidget:!0,genome:"hg38"},googleConfig:{apiKey:"AIzaSyDUUAUFpQEN4mumeMNIRWXSiTh5cPtUAD0",clientId:"661332306814-8nt29308rppg325bkq372vli8nm3na14.apps.googleusercontent.com"},urlShortener:{provider:"bitly"}})})}]);